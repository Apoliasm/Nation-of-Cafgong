# .github/workflows/cd-release.yml
name: CD to EC2 on Main

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ðŸ“¦ Install dependencies
        run: yarn install --immutable

      - name: ðŸ›  Build the app
        run: yarn build

      - name: ðŸ³ Build Docker image
        run: docker build -t noc .

      - name: ðŸš€ Deploy to EC2
        run: |
          echo "$SSH_KEY" > ec2_key.pem
          chmod 600 ec2_key.pem


          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_HOST }} << 'EOF'
            sudo docker stop noc-main || true
            sudo docker rm noc-main || true
            sudo docker rmi noc-main || true
            cd Nation-of-Cafgong/noc-front
            git fetch origin
            git checkout main
            git pull origin main
            sudo docker build -t noc-main .
            sudo docker run -d -p 3000:3000 --name noc-main noc-main
          EOF
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
